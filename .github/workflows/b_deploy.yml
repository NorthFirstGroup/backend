# Workflow åç¨±ï¼Œæœƒé¡¯ç¤ºåœ¨ GitHub Actions UI ä¸Š
name: Deploy Backend via Docker Compose

# é€™å€‹ GitHub Action ç”¨ä¾†è‡ªå‹•åŒ–éƒ¨ç½² Vue.js å‰ç«¯å°ˆæ¡ˆåˆ° EC2 ä¸Š
on:
    push:
        tags:
            - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest                           # ä½¿ç”¨ GitHub æä¾›çš„ Ubuntu runner åŸ·è¡Œæµç¨‹

    steps:
      - name: Checkout code                          # ç¬¬ä¸€æ­¥ï¼šæ‹‰å– GitHub Repo åŸå§‹ç¢¼åˆ° runner
        uses: actions/checkout@v3

      - name: Upload all files to EC2                # ä¸Šå‚³æ•´å€‹å°ˆæ¡ˆåˆ° EC2 çš„æŒ‡å®šè³‡æ–™å¤¾
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}              # EC2 å…¬ç¶² IPï¼ˆå¾ Secrets æŠ“ï¼‰
          username: ${{ secrets.EC2_USER }}          # é€šå¸¸æ˜¯ ubuntu ä½¿ç”¨è€…
          key: ${{ secrets.EC2_KEY }}                # EC2 ç§é‘°ï¼ˆä¸è¦ commitï¼ï¼‰
          source: "."                                # ä¸Šå‚³æ•´å€‹ repoï¼ˆå« Dockerfile ç­‰ï¼‰
          target: "~/project/goticket/CICD/backend"  # ä¸Šå‚³åˆ° EC2 çš„è³‡æ–™å¤¾ä½ç½®

      - name: Create .env file on EC2                # é ç«¯å»ºç«‹å¾Œç«¯ç”¨çš„ .env ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cat <<EOF > ~/project/goticket/CICD/backend/.env
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            DB_HOST=postgres
            DB_PORT=5432
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_DATABASE=${{ secrets.DB_DATABASE }}
            DB_SYNCHRONIZE=true
            DB_ENABLE_SSL=false

            REDIS_HOST=redis
            REDIS_PORT=6379

            PORT=8080
            LOG_LEVEL=debug

            JWT_EXPIRES_DAY=30d
            JWT_SECRET=${{ secrets.JWT_SECRET }}

            MAIL_USER=${{ secrets.MAIL_USER }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            MAIL_JWT_EXPIRES_MINUTE=5m

            AWS_S3_REGION=${{ secrets.AWS_S3_REGION }}
            AWS_S3_ACCESS_KEY_ID=${{ secrets.AWS_S3_ACCESS_KEY_ID }}
            AWS_S3_SECRET_ACCESS_KEY=${{ secrets.AWS_S3_SECRET_ACCESS_KEY }}
            AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
            EOF

      - name: SSH into EC2 and build + restart Docker  # åŸ·è¡Œ npm build å’Œé‡å•Ÿ Docker å®¹å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd ~/project/goticket/CICD/backend            # åˆ‡æ›åˆ°ä¸Šå‚³çš„è³‡æ–™å¤¾
            npm install                                   # å®‰è£å¾Œç«¯ä¾è³´
            npm run build                                 # ç·¨è­¯ TypeScript ç¨‹å¼ç¢¼
            docker compose --env-file .env down           # åœæ­¢ç¾æœ‰å®¹å™¨
            docker compose --env-file .env up -d --build  # é‡æ–°å»ºç½®ä¸¦å•Ÿå‹•å®¹å™¨

      - name: Get latest commit message  # å–å¾—æœ€æ–°ä¸€æ¬¡ commit è¨Šæ¯ï¼ˆç”¨æ–¼é€šçŸ¥ï¼‰
        id: commit
        run: echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT

      - name: Notify Discord  # ä¸è«–æˆåŠŸæˆ–å¤±æ•—éƒ½é€šçŸ¥ Discord é »é“
        if: always()
        run: |
          STATUS="${{ job.status }}"  # å–å¾—åŸ·è¡Œç‹€æ…‹ success / failure
          COLOR="âœ…"
          TITLE="å¾Œç«¯éƒ¨ç½²æˆåŠŸ ğŸš€"

          if [ "$STATUS" != "success" ]; then
            COLOR="âŒ"
            TITLE="å¾Œç«¯éƒ¨ç½²å¤±æ•— â—ï¸è«‹ç›¡é€Ÿè™•ç†"
          fi

          # å‚³é€ Webhook çµ¦ Discord
          curl -X POST ${{ secrets.DISCORD_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"$COLOR $TITLE\nğŸ“¦ å°ˆæ¡ˆï¼š${{ github.repository }}\nğŸ‘¤ æ¨é€è€…ï¼š${{ github.event.pusher.name }}\nğŸ”€ Commitï¼š${{ steps.commit.outputs.message }}\nğŸŒ¿ åˆ†æ”¯ï¼š${{ github.ref_name }}\nğŸ• æ™‚é–“ï¼š$(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M')\"
            }"
